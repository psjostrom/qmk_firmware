/* Copyright 2021 Carlos Martins
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include QMK_KEYBOARD_H
// #include <stdio.h>
#include "psjostrom.h"

// Start of underglow layer control
const rgblight_segment_t PROGMEM qwerty_layer[] = RGBLIGHT_LAYER_SEGMENTS(
    // QWERTY = Blue underglow
    {0, 80, HSV_BLUE}
);

const rgblight_segment_t PROGMEM swe_layer[] = RGBLIGHT_LAYER_SEGMENTS(
    // SWE = White underglow
    {0, 80, HSV_WHITE}
);

const rgblight_segment_t PROGMEM lower_layer[] = RGBLIGHT_LAYER_SEGMENTS(
    // LOWER = Red underglow
    {0, 80, HSV_RED}
);

const rgblight_segment_t PROGMEM raise_layer[] = RGBLIGHT_LAYER_SEGMENTS(
    // RAISE = Orange underglow
    {0, 80, HSV_ORANGE}
);

const rgblight_segment_t PROGMEM adjust_layer[] = RGBLIGHT_LAYER_SEGMENTS(
    // ADJUST = Light green underglow
    {0, 80, HSV_SPRINGGREEN}
);

const rgblight_segment_t* const PROGMEM underglow_layers[] = RGBLIGHT_LAYERS_LIST(
    qwerty_layer,
    swe_layer,
    lower_layer,
    raise_layer,
    adjust_layer

);

void keyboard_post_init_user(void) {
    // Enable the LED layers
    rgblight_layers = underglow_layers;
}

layer_state_t default_layer_state_set_user(layer_state_t state) {
    rgblight_set_layer_state(0, layer_state_cmp(state, LY_BASE));
    rgblight_set_layer_state(1, layer_state_cmp(state, LY_SWE));

    return state;
}

layer_state_t layer_state_set_user(layer_state_t state) {
    rgblight_set_layer_state(2, layer_state_cmp(state, LY_LOWER));
    rgblight_set_layer_state(3, layer_state_cmp(state, LY_RAISE));
    rgblight_set_layer_state(4, layer_state_cmp(state, LY_ADJUST));

    return state;
}
// End of underglow layer control

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
  [LY_BASE] = LAYOUT(
  KC_GRV,         KC_1, KC_2,           KC_3,           KC_4,    KC_5,                      KC_6,     KC_7, KC_8,       KC_9,   KC_0,    KC_BSPC,  \
  KC_TAB,         KC_Q, KC_W,           KC_E,           KC_R,    KC_T,                      KC_Y,     KC_U, KC_I,       KC_O,   KC_P,    KC_DEL, \
  LCTL_T(KC_ESC), KC_A, KC_S,           KC_D,           KC_F,    KC_G,                      KC_H,     KC_J, KC_K,       KC_L,   KC_SCLN, KC_QUOT, \
  LSFT_T(KC_F12), KC_Z, KC_X,           KC_C,           KC_V,    KC_B,     CG_TOGG, KC_SWE, KC_N,     KC_M, KC_COMM,    KC_DOT, KC_SLSH, KC_RIGHT,  \
                        LGUI_T(KC_F13), LALT_T(KC_F16), KC_LCTL, KC_LOWER, KC_SPC,  KC_ENT, KC_RAISE, KC_LEFT, KC_DOWN, KC_UP
  ),

  [LY_SWE] = LAYOUT(
  KC_GRV,         KC_1, KC_2,           KC_3,           KC_4,    KC_5,                         KC_6,     KC_7, KC_8,       KC_9,   KC_0,          KC_BSPC,  \
  KC_TAB,         KC_Q, KC_W,           KC_E,           KC_R,    KC_T,                         KC_Y,     KC_U, KC_I,       KC_O,   KC_P,          LALT(KC_LBRC), \
  LCTL_T(KC_ESC), KC_A, KC_S,           KC_D,           KC_F,    KC_G,                         KC_H,     KC_J, KC_K,       KC_L,   LALT(KC_SCLN), LALT(KC_QUOT), \
  LSFT_T(KC_F12), KC_Z, KC_X,           KC_C,           KC_V,    KC_B,     CG_TOGG, KC_BASE,   KC_N,     KC_M, KC_COMM,    KC_DOT, KC_SLSH,       KC_RIGHT,  \
                        LGUI_T(KC_F13), LALT_T(KC_F16), KC_LCTL, KC_LOWER, KC_SPC,  KC_ENT,    KC_RAISE, KC_LEFT, KC_DOWN, KC_UP
  ),

  [LY_LOWER] = LAYOUT(
  _______, KC_F1,   KC_F2,         KC_F3,   KC_F4,       KC_F5,                     KC_F6,   KC_F7,   KC_F8,   KC_F9,   KC_F10,  _______, \
  _______, _______, LGUI(KC_DOWN), KC_UP,   LGUI(KC_UP), _______,                   _______, _______, _______, _______, _______, _______, \
  _______, _______, KC_LEFT,       KC_DOWN, KC_RGHT,     _______,                   _______, KC_UNDS, KC_PLUS, KC_LCBR, KC_RCBR, KC_PIPE, \
  _______, _______, _______,       _______, _______,     _______, _______, _______, _______, _______, KC_COLN, KC_DQUO, _______, _______, \
                    _______,       _______, _______,     _______, KC_DEL,  KC_BSPC, _______, _______, _______, _______
  ),

  [LY_RAISE] = LAYOUT(
  _______, KC_F1,      KC_F2,         KC_F3,      KC_F4,        KC_F5,                     KC_F6,   KC_F7,   KC_F8,   KC_F9,   KC_F10,  _______, \
  _______, _______,    LCTL(KC_MINS), KC_LEND,    RCS(KC_MINS), _______,                   _______, _______, _______, _______, _______, _______, \
  _______, KC_DLINE,   KC_PRVWD,      KC_LSTRT,   KC_NXTWD,     _______,                   _______, KC_MINS, KC_EQL,  KC_LBRC, KC_RBRC, KC_BSLS, \
  _______, LGUI(KC_Z), LGUI(KC_X),    LGUI(KC_C), LGUI(KC_V),   _______, _______, _______, _______, _______, KC_SCLN, KC_QUOT, _______, _______, \
                       _______,       _______,    _______,      _______, KC_DEL,  KC_BSPC, _______, _______, _______, _______
  ),

  [LY_ADJUST] = LAYOUT(
  SLEEP,   _______, _______, _______, RGB_TOG, RGB_MOD,                    RGB_SAD, RGB_SAI, RGB_HUD, RGB_HUI, RGB_VAD, RGB_VAI, \
  _______, RESET,   _______, KC_MPRV, KC_MNXT, _______,                    _______, _______, _______, _______, _______, _______, \
  _______, KC_VOLD, KC_VOLU, KC_MUTE, KC_MPLY, CG_TOGG,                    _______, KC_LEFT, KC_DOWN, KC_UP,   KC_RGHT, _______, \
  _______, KC_F17,  KC_F18,  KC_F19,  KC_F10,  _______, _______,  _______, _______, _______, _______, _______, _______, _______, \
                    _______, _______, _______, _______, KC_QWERTY, KC_SWE, _______, _______, _______, _______
  )
};

#ifdef OLED_ENABLE

/* 32 * 14 os logos */
static const char PROGMEM windows_logo[] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xbc, 0xbc, 0xbe, 0xbe, 0x00, 0xbe, 0xbe, 0xbf, 0xbf, 0xbf, 0xbf, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x07, 0x0f, 0x0f, 0x00, 0x0f, 0x0f, 0x1f, 0x1f, 0x1f, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

static const char PROGMEM mac_logo[] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xf0, 0xf8, 0xf8, 0xf8, 0xf0, 0xf6, 0xfb, 0xfb, 0x38, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x07, 0x0f, 0x1f, 0x1f, 0x0f, 0x0f, 0x1f, 0x1f, 0x0f, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

static const char PROGMEM tree_logo[] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xe0, 0xf0, 0xf8, 0xfe, 0xff,
0xff, 0xfe, 0xf8, 0xf0, 0xe0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x86, 0xe7, 0xf7, 0xff, 0xff, 0xff, 0xff, 0xff,
0xff, 0xff, 0xff, 0xff, 0xff, 0xf7, 0xe7, 0x86, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x86, 0xe7, 0xf7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf7, 0xe7, 0x86, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x06, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x87, 0xe7, 0xff, 0xff, 0xff,
0xff, 0xff, 0xff, 0xe7, 0x87, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x06, 0x00, 0x00, 0x00, 0x00};

static const char PROGMEM bread_pigeon_logo[] = {0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0x0f, 0x0f, 0xff, 0xff, 0x1f, 0x1f, 0xff, 0xff, 0x0f, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0xff, 0xff, 0x7f, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0x7f, 0x7f, 0x63, 0xc7, 0x0f, 0x0f, 0x07, 0x47, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x3f, 0x9f, 0xff, 0xff, 0x1f, 0x1f,
0x9f, 0x1f, 0xdf, 0xff, 0xff, 0xff, 0xff, 0xf7, 0x77, 0x77, 0x37, 0xb7, 0x97, 0xc7, 0xc7, 0xe7,
0xf7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0x38, 0x18, 0xd9, 0xd9, 0x18, 0x18, 0x99, 0xd9, 0xd8, 0xd8, 0xff, 0xff, 0xff, 0xff, 0x83, 0x80,
0x9e, 0x9e, 0x9e, 0x9e, 0x9e, 0x9c, 0x80, 0x83, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x1f, 0x77, 0x3b, 0x39, 0x3b, 0x7f, 0xc7, 0x9d,
0x3d, 0x7d, 0x7b, 0xfa, 0xe0, 0xf8, 0xb0, 0xb0, 0x01, 0x07, 0xdf, 0x9f, 0x0f, 0xbf, 0xff, 0xff,
0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7c, 0x70, 0x67, 0x67, 0x6f, 0x6f, 0x67,
0x67, 0x70, 0x7c, 0xff, 0xff, 0xff, 0xff, 0x3c, 0x1c, 0xcc, 0xec, 0xec, 0xec, 0xec, 0xcc, 0x1c,
0x3c, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0x70, 0x30, 0xb3, 0xb3, 0x70, 0x30, 0xb3, 0xb3, 0x33, 0x73, 0xff, 0xff, 0xff, 0xff, 0xe7, 0xc7,
0xc7, 0xd3, 0x9b, 0xbb, 0x81, 0x01, 0x3d, 0x7c, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0xff, 0xff, 0xff, 0xff, 0x81, 0x80, 0x0c, 0x1c, 0xcc, 0x00, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x01,
0x03, 0x06, 0x1c, 0xf8, 0xe0, 0x83, 0x01, 0x00, 0xc0, 0xe0, 0x83, 0xaf, 0xfe, 0xfe, 0xff, 0xff,
0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1e, 0x0e, 0xe6, 0xf6, 0xe6, 0x06, 0x1e,
0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff, 0xff, 0x3e, 0x38, 0xf3, 0xf3, 0x77, 0x77, 0xf3, 0xf3, 0x38,
0x3e, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0xe0, 0xe0, 0xe7, 0xe7, 0xe0, 0xe0, 0xe7, 0xe7, 0xe0, 0xe0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0xff, 0xff, 0xff, 0xfe, 0xf8, 0xf0,
0xc8, 0xdc, 0xcc, 0xe6, 0xf3, 0xf9, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc,
0xfc, 0xfc, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xe0, 0xe0, 0xe7, 0xe7, 0xe0, 0xe0, 0xe7, 0xe7, 0xe0,
0xe0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff};

static void render_logo(void) {
    oled_write_raw_P(bread_pigeon_logo, sizeof(bread_pigeon_logo));
}

static void print_status_narrow(void) {
    /* Print current mode */
    oled_set_cursor(0, 0);
    if (keymap_config.swap_lctl_lgui) {
        oled_write_raw_P(mac_logo, sizeof(mac_logo));
    } else {
        oled_write_raw_P(windows_logo, sizeof(windows_logo));
    }

    oled_set_cursor(0, 3);

    switch (get_highest_layer(default_layer_state)) {
        case LY_BASE:
            oled_write("QWRTY", false);
            break;
        case LY_SWE:
            oled_write("SWEDE", false);
            break;
        default:
            oled_write("UNDEF", false);
    }

    /* Print current layer */
    oled_set_cursor(0, 6);
    switch (get_highest_layer(layer_state)) {
        case LY_BASE:
            oled_write("Stdrd", false);
            break;
        case LY_RAISE:
            oled_write("Raise", false);
            break;
        case LY_LOWER:
            oled_write("Lower", false);
            break;
        case LY_ADJUST:
            oled_write("Adjst", false);
            break;
        default:
            oled_write("Undef", false);
    }

    oled_set_cursor(0, 12);
    oled_write_raw_P(tree_logo, sizeof(tree_logo));
}

oled_rotation_t oled_init_user(oled_rotation_t rotation) {
    if (is_keyboard_master()) {
        return OLED_ROTATION_270;
    }
    else {
        return OLED_ROTATION_180;
    }
    return rotation;
}

bool oled_task_user(void) {
    if (is_keyboard_master()) {
        print_status_narrow();
    } else {
        render_logo();
    }
    return false;
}

#endif


#ifdef ENCODER_ENABLE

bool encoder_update_user(uint8_t index, bool clockwise) {
    if (index == 0) {
        encoder_action_vscode_nav(clockwise);
    } else if (index == 1) {
        encoder_action_undo_redo(clockwise);
    }
    return true;
}
#endif
